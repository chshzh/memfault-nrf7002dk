name: Build Memfault nRF7002DK

on:
  push:
    branches: [ main, dev/refactoring ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, dev/refactoring ]

jobs:
  set-version:
    runs-on: ubuntu-24.04
    outputs:
      NCS_VERSION: ${{ steps.extract-version.outputs.NCS_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: app-workspace/memfault-nrf7002dk

      - name: Extract NCS version from west.yml
        id: extract-version
        working-directory: app-workspace/memfault-nrf7002dk
        run: |
          NCS_VERSION=$(grep 'revision:' west.yml | awk '{print $2}')
          echo "NCS_VERSION=${NCS_VERSION}" >> $GITHUB_OUTPUT

  build-and-test:
    needs: set-version
    runs-on: ubuntu-24.04
    container: ghcr.io/nrfconnect/sdk-nrf-toolchain:${{ needs.set-version.outputs.NCS_VERSION }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: app-workspace/memfault-nrf7002dk

      - name: Prepare west workspace
        working-directory: app-workspace
        run: |
          west init -l memfault-nrf7002dk
          west update -o=--depth=1 -n

      - name: Create Memfault project key overlay
        working-directory: app-workspace/memfault-nrf7002dk
        run: |
          # Use the GitHub secret if available; fall back to the dummy key in prj.conf
          if [ -n "${{ secrets.MEMFAULT_PROJECT_KEY }}" ]; then
            echo 'CONFIG_MEMFAULT_NCS_PROJECT_KEY="${{ secrets.MEMFAULT_PROJECT_KEY }}"' > overlay-ci-key.conf
            echo "Using MEMFAULT_PROJECT_KEY from GitHub secrets"
          else
            echo "# No secret set; build uses dummy key from prj.conf" > overlay-ci-key.conf
            echo "No MEMFAULT_PROJECT_KEY secret configured; using dummy key"
          fi

      - name: Build nRF7002DK (nrf5340/cpuapp)
        working-directory: app-workspace/memfault-nrf7002dk
        run: |
          west build -p -b nrf7002dk/nrf5340/cpuapp -d build_nrf7002dk -- \
            -DEXTRA_CONF_FILE="overlay-ci-key.conf"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-nrf7002dk
          path: app-workspace/memfault-nrf7002dk/build_nrf7002dk/zephyr/merged.hex

  validate-documentation:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: app-workspace/memfault-nrf7002dk

      - name: Validate README structure
        working-directory: app-workspace/memfault-nrf7002dk
        run: |
          echo "Validating README.md structure..."
          grep -q "Overview" README.md || (echo "Missing Overview section" && exit 1)
          grep -q "Hardware" README.md || (echo "Missing Hardware section" && exit 1)
          grep -q "Quick Start" README.md || (echo "Missing Quick Start section" && exit 1)
          grep -q "west build" README.md || (echo "Missing build commands" && exit 1)
          grep -q "Project Structure" README.md || (echo "Missing Project Structure section" && exit 1)
          echo "README.md validation passed"

      - name: Validate configuration files
        working-directory: app-workspace/memfault-nrf7002dk
        run: |
          echo "Checking configuration files..."
          [ -f prj.conf ] || (echo "Missing prj.conf" && exit 1)
          [ -f west.yml ] || (echo "Missing west.yml" && exit 1)
          [ -f CMakeLists.txt ] || (echo "Missing CMakeLists.txt" && exit 1)
          [ -f Kconfig ] || (echo "Missing Kconfig" && exit 1)
          [ -f LICENSE ] || (echo "Missing LICENSE" && exit 1)
          echo "Configuration files validation passed"

  static-analysis:
    needs: set-version
    runs-on: ubuntu-24.04
    container: ghcr.io/nrfconnect/sdk-nrf-toolchain:${{ needs.set-version.outputs.NCS_VERSION }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: app-workspace/memfault-nrf7002dk

      - name: Prepare west project
        working-directory: app-workspace
        run: |
          west init -l memfault-nrf7002dk
          west update -o=--depth=1 -n

      - name: Run Zephyr checkpatch
        working-directory: app-workspace
        run: |
          echo "Running Zephyr checkpatch on source files..."
          if [ -d memfault-nrf7002dk/src/ ]; then
            for file in $(find memfault-nrf7002dk/src/ -name "*.c" -o -name "*.h" 2>/dev/null); do
              if [ -f "$file" ]; then
                echo "Checking $file..."
                ./zephyr/scripts/checkpatch.pl --no-tree --file "$file" || true
              fi
            done
          fi
          echo "Checkpatch analysis completed"
